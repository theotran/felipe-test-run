'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _utils = require('./utils');

var _utils2 = _interopRequireDefault(_utils);

var _defaultProps = require('./defaultProps');

var _defaultProps2 = _interopRequireDefault(_defaultProps);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

exports.default = {
  getDefaultProps: function getDefaultProps() {
    return _defaultProps2.default;
  },
  getInitialState: function getInitialState() {
    return {
      page: 0,
      pageSize: this.props.defaultPageSize || 10,
      sorting: this.props.defaultSorting,
      expandedRows: {},
      filtering: this.props.defaultFiltering,
      resizing: this.props.defaultResizing,
      currentlyResizing: undefined,
      skipNextSort: false
    };
  },
  getResolvedState: function getResolvedState(props, state) {
    var resolvedState = _extends({}, _utils2.default.compactObject(this.state), _utils2.default.compactObject(this.props), _utils2.default.compactObject(state), _utils2.default.compactObject(props));
    return resolvedState;
  },
  componentWillMount: function componentWillMount() {
    this.setStateWithData(this.getDataModel(this.getResolvedState()));
  },
  componentDidMount: function componentDidMount() {
    this.fireOnChange();
  },
  componentWillReceiveProps: function componentWillReceiveProps(nextProps, nextState) {
    var oldState = this.getResolvedState();
    var newState = this.getResolvedState(nextProps, nextState);

    if (oldState.defaultSorting !== newState.defaultSorting) {
      newState.sorting = newState.defaultSorting;
    }

    if (oldState.showFilters !== newState.showFilters || oldState.showFilters !== newState.showFilters) {
      newState.filtering = newState.defaultFiltering;
    }

    // Props that trigger a data update
    if (oldState.data !== newState.data || oldState.columns !== newState.columns || oldState.pivotBy !== newState.pivotBy || oldState.sorting !== newState.sorting || oldState.showFilters !== newState.showFilters || oldState.filtering !== newState.filtering) {
      this.setStateWithData(this.getDataModel(newState));
    }
  },
  setStateWithData: function setStateWithData(newState, cb) {
    var oldState = this.getResolvedState();
    var newResolvedState = this.getResolvedState({}, newState);
    var freezeWhenExpanded = newResolvedState.freezeWhenExpanded;

    // Default to unfrozen state

    newResolvedState.frozen = false;

    // If freezeWhenExpanded is set, check for frozen conditions
    if (freezeWhenExpanded) {
      // if any rows are expanded, freeze the existing data and sorting
      var keys = Object.keys(newResolvedState.expandedRows);
      for (var i = 0; i < keys.length; i++) {
        if (newResolvedState.expandedRows[keys[i]]) {
          newResolvedState.frozen = true;
          break;
        }
      }
    }

    // If the data isn't frozen and either the data or
    // sorting model has changed, update the data
    if (oldState.frozen && !newResolvedState.frozen || oldState.sorting !== newResolvedState.sorting || oldState.filtering !== newResolvedState.filtering || oldState.showFilters !== newResolvedState.showFilters || !newResolvedState.frozen && oldState.resolvedData !== newResolvedState.resolvedData) {
      // Handle collapseOnSortingChange & collapseOnDataChange
      if (oldState.sorting !== newResolvedState.sorting && this.props.collapseOnSortingChange || oldState.filtering !== newResolvedState.filtering || oldState.showFilters !== newResolvedState.showFilters || !newResolvedState.frozen && oldState.resolvedData !== newResolvedState.resolvedData && this.props.collapseOnDataChange) {
        newResolvedState.expandedRows = {};
      }

      Object.assign(newResolvedState, this.getSortedData(newResolvedState));
    }

    // Calculate pageSize all the time
    if (newResolvedState.sortedData) {
      newResolvedState.pages = newResolvedState.manual ? newResolvedState.pages : Math.ceil(newResolvedState.sortedData.length / newResolvedState.pageSize);
      newResolvedState.page = Math.max(newResolvedState.page >= newResolvedState.pages ? newResolvedState.pages - 1 : newResolvedState.page, 0);
    }

    return this.setState(newResolvedState, cb);
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9saWZlY3ljbGUuanMiXSwibmFtZXMiOlsiZ2V0RGVmYXVsdFByb3BzIiwiZ2V0SW5pdGlhbFN0YXRlIiwicGFnZSIsInBhZ2VTaXplIiwicHJvcHMiLCJkZWZhdWx0UGFnZVNpemUiLCJzb3J0aW5nIiwiZGVmYXVsdFNvcnRpbmciLCJleHBhbmRlZFJvd3MiLCJmaWx0ZXJpbmciLCJkZWZhdWx0RmlsdGVyaW5nIiwicmVzaXppbmciLCJkZWZhdWx0UmVzaXppbmciLCJjdXJyZW50bHlSZXNpemluZyIsInVuZGVmaW5lZCIsInNraXBOZXh0U29ydCIsImdldFJlc29sdmVkU3RhdGUiLCJzdGF0ZSIsInJlc29sdmVkU3RhdGUiLCJjb21wYWN0T2JqZWN0IiwiY29tcG9uZW50V2lsbE1vdW50Iiwic2V0U3RhdGVXaXRoRGF0YSIsImdldERhdGFNb2RlbCIsImNvbXBvbmVudERpZE1vdW50IiwiZmlyZU9uQ2hhbmdlIiwiY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyIsIm5leHRQcm9wcyIsIm5leHRTdGF0ZSIsIm9sZFN0YXRlIiwibmV3U3RhdGUiLCJzaG93RmlsdGVycyIsImRhdGEiLCJjb2x1bW5zIiwicGl2b3RCeSIsImNiIiwibmV3UmVzb2x2ZWRTdGF0ZSIsImZyZWV6ZVdoZW5FeHBhbmRlZCIsImZyb3plbiIsImtleXMiLCJPYmplY3QiLCJpIiwibGVuZ3RoIiwicmVzb2x2ZWREYXRhIiwiY29sbGFwc2VPblNvcnRpbmdDaGFuZ2UiLCJjb2xsYXBzZU9uRGF0YUNoYW5nZSIsImFzc2lnbiIsImdldFNvcnRlZERhdGEiLCJzb3J0ZWREYXRhIiwicGFnZXMiLCJtYW51YWwiLCJNYXRoIiwiY2VpbCIsIm1heCIsInNldFN0YXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7OztrQkFFZTtBQUNiQSxpQkFEYSw2QkFDTTtBQUNqQjtBQUNELEdBSFk7QUFLYkMsaUJBTGEsNkJBS007QUFDakIsV0FBTztBQUNMQyxZQUFN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aUJBQWlCYSxLQUFqQixHQUF5QixDQUEzRSxHQUErRWIsaUJBQWlCakMsSUFBekcsRUFBK0csQ0FBL0csQ0FBeEI7QUFDRDs7QUFFRCxXQUFPLEtBQUttRCxRQUFMLENBQWNsQixnQkFBZCxFQUFnQ0QsRUFBaEMsQ0FBUDtBQUNEO0FBL0dZLEMiLCJmaWxlIjoibGlmZWN5Y2xlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnLi91dGlscydcbmltcG9ydCBkZWZhdWx0UHJvcHMgZnJvbSAnLi9kZWZhdWx0UHJvcHMnXG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgZ2V0RGVmYXVsdFByb3BzICgpIHtcbiAgICByZXR1cm4gZGVmYXVsdFByb3BzXG4gIH0sXG5cbiAgZ2V0SW5pdGlhbFN0YXRlICgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgcGFnZTogMCxcbiAgICAgIHBhZ2VTaXplOiB0aGlzLnByb3BzLmRlZmF1bHRQYWdlU2l6ZSB8fCAxMCxcbiAgICAgIHNvcnRpbmc6IHRoaXMucHJvcHMuZGVmYXVsdFNvcnRpbmcsXG4gICAgICBleHBhbmRlZFJvd3M6IHt9LFxuICAgICAgZmlsdGVyaW5nOiB0aGlzLnByb3BzLmRlZmF1bHRGaWx0ZXJpbmcsXG4gICAgICByZXNpemluZzogdGhpcy5wcm9wcy5kZWZhdWx0UmVzaXppbmcsXG4gICAgICBjdXJyZW50bHlSZXNpemluZzogdW5kZWZpbmVkLFxuICAgICAgc2tpcE5leHRTb3J0OiBmYWxzZVxuICAgIH1cbiAgfSxcblxuICBnZXRSZXNvbHZlZFN0YXRlIChwcm9wcywgc3RhdGUpIHtcbiAgICBjb25zdCByZXNvbHZlZFN0YXRlID0ge1xuICAgICAgLi4uXy5jb21wYWN0T2JqZWN0KHRoaXMuc3RhdGUpLFxuICAgICAgLi4uXy5jb21wYWN0T2JqZWN0KHRoaXMucHJvcHMpLFxuICAgICAgLi4uXy5jb21wYWN0T2JqZWN0KHN0YXRlKSxcbiAgICAgIC4uLl8uY29tcGFjdE9iamVjdChwcm9wcylcbiAgICB9XG4gICAgcmV0dXJuIHJlc29sdmVkU3RhdGVcbiAgfSxcblxuICBjb21wb25lbnRXaWxsTW91bnQgKCkge1xuICAgIHRoaXMuc2V0U3RhdGVXaXRoRGF0YSh0aGlzLmdldERhdGFNb2RlbCh0aGlzLmdldFJlc29sdmVkU3RhdGUoKSkpXG4gIH0sXG5cbiAgY29tcG9uZW50RGlkTW91bnQgKCkge1xuICAgIHRoaXMuZmlyZU9uQ2hhbmdlKClcbiAgfSxcblxuICBjb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzIChuZXh0UHJvcHMsIG5leHRTdGF0ZSkge1xuICAgIGNvbnN0IG9sZFN0YXRlID0gdGhpcy5nZXRSZXNvbHZlZFN0YXRlKClcbiAgICBjb25zdCBuZXdTdGF0ZSA9IHRoaXMuZ2V0UmVzb2x2ZWRTdGF0ZShuZXh0UHJvcHMsIG5leHRTdGF0ZSlcblxuICAgIGlmIChvbGRTdGF0ZS5kZWZhdWx0U29ydGluZyAhPT0gbmV3U3RhdGUuZGVmYXVsdFNvcnRpbmcpIHtcbiAgICAgIG5ld1N0YXRlLnNvcnRpbmcgPSBuZXdTdGF0ZS5kZWZhdWx0U29ydGluZ1xuICAgIH1cblxuICAgIGlmICgob2xkU3RhdGUuc2hvd0ZpbHRlcnMgIT09IG5ld1N0YXRlLnNob3dGaWx0ZXJzKSB8fFxuICAgICAgKG9sZFN0YXRlLnNob3dGaWx0ZXJzICE9PSBuZXdTdGF0ZS5zaG93RmlsdGVycykpIHtcbiAgICAgIG5ld1N0YXRlLmZpbHRlcmluZyA9IG5ld1N0YXRlLmRlZmF1bHRGaWx0ZXJpbmdcbiAgICB9XG5cbiAgICAvLyBQcm9wcyB0aGF0IHRyaWdnZXIgYSBkYXRhIHVwZGF0ZVxuICAgIGlmIChcbiAgICAgIG9sZFN0YXRlLmRhdGEgIT09IG5ld1N0YXRlLmRhdGEgfHxcbiAgICAgIG9sZFN0YXRlLmNvbHVtbnMgIT09IG5ld1N0YXRlLmNvbHVtbnMgfHxcbiAgICAgIG9sZFN0YXRlLnBpdm90QnkgIT09IG5ld1N0YXRlLnBpdm90QnkgfHxcbiAgICAgIG9sZFN0YXRlLnNvcnRpbmcgIT09IG5ld1N0YXRlLnNvcnRpbmcgfHxcbiAgICAgIG9sZFN0YXRlLnNob3dGaWx0ZXJzICE9PSBuZXdTdGF0ZS5zaG93RmlsdGVycyB8fFxuICAgICAgb2xkU3RhdGUuZmlsdGVyaW5nICE9PSBuZXdTdGF0ZS5maWx0ZXJpbmdcbiAgICApIHtcbiAgICAgIHRoaXMuc2V0U3RhdGVXaXRoRGF0YSh0aGlzLmdldERhdGFNb2RlbChuZXdTdGF0ZSkpXG4gICAgfVxuICB9LFxuXG4gIHNldFN0YXRlV2l0aERhdGEgKG5ld1N0YXRlLCBjYikge1xuICAgIGNvbnN0IG9sZFN0YXRlID0gdGhpcy5nZXRSZXNvbHZlZFN0YXRlKClcbiAgICBjb25zdCBuZXdSZXNvbHZlZFN0YXRlID0gdGhpcy5nZXRSZXNvbHZlZFN0YXRlKHt9LCBuZXdTdGF0ZSlcbiAgICBjb25zdCB7ZnJlZXplV2hlbkV4cGFuZGVkfSA9IG5ld1Jlc29sdmVkU3RhdGVcblxuICAgIC8vIERlZmF1bHQgdG8gdW5mcm96ZW4gc3RhdGVcbiAgICBuZXdSZXNvbHZlZFN0YXRlLmZyb3plbiA9IGZhbHNlXG5cbiAgICAvLyBJZiBmcmVlemVXaGVuRXhwYW5kZWQgaXMgc2V0LCBjaGVjayBmb3IgZnJvemVuIGNvbmRpdGlvbnNcbiAgICBpZiAoZnJlZXplV2hlbkV4cGFuZGVkKSB7XG4gICAgICAvLyBpZiBhbnkgcm93cyBhcmUgZXhwYW5kZWQsIGZyZWV6ZSB0aGUgZXhpc3RpbmcgZGF0YSBhbmQgc29ydGluZ1xuICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKG5ld1Jlc29sdmVkU3RhdGUuZXhwYW5kZWRSb3dzKVxuICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBrZXlzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGlmIChuZXdSZXNvbHZlZFN0YXRlLmV4cGFuZGVkUm93c1trZXlzW2ldXSkge1xuICAgICAgICAgIG5ld1Jlc29sdmVkU3RhdGUuZnJvemVuID0gdHJ1ZVxuICAgICAgICAgIGJyZWFrXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBJZiB0aGUgZGF0YSBpc24ndCBmcm96ZW4gYW5kIGVpdGhlciB0aGUgZGF0YSBvclxuICAgIC8vIHNvcnRpbmcgbW9kZWwgaGFzIGNoYW5nZWQsIHVwZGF0ZSB0aGUgZGF0YVxuICAgIGlmIChcbiAgICAgIChvbGRTdGF0ZS5mcm96ZW4gJiYgIW5ld1Jlc29sdmVkU3RhdGUuZnJvemVuKSB8fFxuICAgICAgb2xkU3RhdGUuc29ydGluZyAhPT0gbmV3UmVzb2x2ZWRTdGF0ZS5zb3J0aW5nIHx8XG4gICAgICBvbGRTdGF0ZS5maWx0ZXJpbmcgIT09IG5ld1Jlc29sdmVkU3RhdGUuZmlsdGVyaW5nIHx8XG4gICAgICBvbGRTdGF0ZS5zaG93RmlsdGVycyAhPT0gbmV3UmVzb2x2ZWRTdGF0ZS5zaG93RmlsdGVycyB8fFxuICAgICAgKCFuZXdSZXNvbHZlZFN0YXRlLmZyb3plbiAmJiBvbGRTdGF0ZS5yZXNvbHZlZERhdGEgIT09IG5ld1Jlc29sdmVkU3RhdGUucmVzb2x2ZWREYXRhKVxuICAgICkge1xuICAgICAgLy8gSGFuZGxlIGNvbGxhcHNlT25Tb3J0aW5nQ2hhbmdlICYgY29sbGFwc2VPbkRhdGFDaGFuZ2VcbiAgICAgIGlmIChcbiAgICAgICAgKG9sZFN0YXRlLnNvcnRpbmcgIT09IG5ld1Jlc29sdmVkU3RhdGUuc29ydGluZyAmJiB0aGlzLnByb3BzLmNvbGxhcHNlT25Tb3J0aW5nQ2hhbmdlKSB8fFxuICAgICAgICAob2xkU3RhdGUuZmlsdGVyaW5nICE9PSBuZXdSZXNvbHZlZFN0YXRlLmZpbHRlcmluZykgfHxcbiAgICAgICAgKG9sZFN0YXRlLnNob3dGaWx0ZXJzICE9PSBuZXdSZXNvbHZlZFN0YXRlLnNob3dGaWx0ZXJzKSB8fFxuICAgICAgICAoIW5ld1Jlc29sdmVkU3RhdGUuZnJvemVuICYmIG9sZFN0YXRlLnJlc29sdmVkRGF0YSAhPT0gbmV3UmVzb2x2ZWRTdGF0ZS5yZXNvbHZlZERhdGEgJiYgdGhpcy5wcm9wcy5jb2xsYXBzZU9uRGF0YUNoYW5nZSlcbiAgICAgICkge1xuICAgICAgICBuZXdSZXNvbHZlZFN0YXRlLmV4cGFuZGVkUm93cyA9IHt9XG4gICAgICB9XG5cbiAgICAgIE9iamVjdC5hc3NpZ24obmV3UmVzb2x2ZWRTdGF0ZSwgdGhpcy5nZXRTb3J0ZWREYXRhKG5ld1Jlc29sdmVkU3RhdGUpKVxuICAgIH1cblxuICAgIC8vIENhbGN1bGF0ZSBwYWdlU2l6ZSBhbGwgdGhlIHRpbWVcbiAgICBpZiAobmV3UmVzb2x2ZWRTdGF0ZS5zb3J0ZWREYXRhKSB7XG4gICAgICBuZXdSZXNvbHZlZFN0YXRlLnBhZ2VzID0gbmV3UmVzb2x2ZWRTdGF0ZS5tYW51YWwgPyBuZXdSZXNvbHZlZFN0YXRlLnBhZ2VzIDogTWF0aC5jZWlsKG5ld1Jlc29sdmVkU3RhdGUuc29ydGVkRGF0YS5sZW5ndGggLyBuZXdSZXNvbHZlZFN0YXRlLnBhZ2VTaXplKVxuICAgICAgbmV3UmVzb2x2ZWRTdGF0ZS5wYWdlID0gTWF0aC5tYXgobmV3UmVzb2x2ZWRTdGF0ZS5wYWdlID49IG5ld1Jlc29sdmVkU3RhdGUucGFnZXMgPyBuZXdSZXNvbHZlZFN0YXRlLnBhZ2VzIC0gMSA6IG5ld1Jlc29sdmVkU3RhdGUucGFnZSwgMClcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5zZXRTdGF0ZShuZXdSZXNvbHZlZFN0YXRlLCBjYilcbiAgfVxufVxuIl19